# SPDX-FileCopyrightText: Copyright (c) 2025 NVIDIA CORPORATION & AFFILIATES. All rights reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
# http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
# SPDX-License-Identifier: Apache-2.0
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ .Release.Namespace }}-backend-operator-token
  annotations:
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-weight": "20"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  template:
    spec:
      restartPolicy: OnFailure
      containers:
      - name: token-generator
        image: alpine/k8s:1.28.4
        command:
        - /bin/sh
        - -c
        - |
          set -e

          apk add --no-cache jq

          BASE_URL="http://{{ .Release.Namespace }}-ingress-nginx-controller.{{ .Release.Namespace }}.svc.cluster.local"
          echo "Using URL: $BASE_URL"

          echo "Waiting for OSMO service to be ready..."
          until curl -f $BASE_URL/api/version; do
            echo "OSMO service not ready, waiting..."
            sleep 10
          done
          echo "OSMO service is ready"

          echo "Checking if secret exists and testing token..."
          if kubectl get secret backend-operator-token -n {{ .Release.Namespace }} >/dev/null 2>&1; then
            echo "Secret exists, extracting token..."

            SECRET_TOKEN_RAW=$(kubectl get secret backend-operator-token -n {{ .Release.Namespace }} -o jsonpath='{.data.token}' | base64 -d)

            echo "DEBUG: Token from secret: [${#SECRET_TOKEN_RAW} chars]"

            if [[ "$SECRET_TOKEN_RAW" == \"*\" ]]; then
              echo "DEBUG: Token appears to be JSON-encoded, parsing with jq..."
              SECRET_TOKEN=$(echo "$SECRET_TOKEN_RAW" | jq -r '.')
            else
              echo "DEBUG: Token appears to be plain text"
              SECRET_TOKEN="$SECRET_TOKEN_RAW"
            fi

            TOKEN_LENGTH=${#SECRET_TOKEN}
            if [ $TOKEN_LENGTH -gt 16 ]; then
              TOKEN_PREVIEW="${SECRET_TOKEN:0:8}...${SECRET_TOKEN: -8}"
            else
              TOKEN_PREVIEW="[SHORT_TOKEN]"
            fi
            echo "DEBUG: Processed token length: $TOKEN_LENGTH"

            echo "Testing token validity..."
            TOKEN_TEST_RESPONSE=$(curl -s -w "%{http_code}" \
              -H "Authorization: Bearer $SECRET_TOKEN" \
              $BASE_URL/api/auth/access_token \
              -G --data-urlencode "access_token=$SECRET_TOKEN" \
              -o /tmp/token_test.json)

            echo "DEBUG: API response code: $TOKEN_TEST_RESPONSE"
            echo "DEBUG: API response body:"
            cat /tmp/token_test.json
            echo ""

            if [ "$TOKEN_TEST_RESPONSE" = "200" ]; then
              echo "Success: backend-operator-token is valid"
              exit 0
            else
              echo "Token test failed, proceeding to recreate..."
            fi
          else
            echo "Secret does not exist, proceeding to create..."
          fi

          echo "Deleting service token backend-operator-token..."
          curl -s -X DELETE \
            $BASE_URL/api/auth/access_token/service/backend-operator-token
          echo "Service token deletion attempted"

          echo "Deleting secret backend-operator-token..."
          kubectl delete secret backend-operator-token -n {{ .Release.Namespace }} --ignore-not-found=true
          echo "Secret deletion completed"

          echo "Creating new service token backend-operator-token..."
          CURRENT_YEAR=$(date +%Y)
          NEXT_YEAR=$((CURRENT_YEAR + 1))
          EXPIRES_AT="${NEXT_YEAR}-$(date +%m-%d)"

          TOKEN_RESPONSE=$(curl -s \
            --max-time 30 \
            --fail-with-body \
            -X POST \
            -H "Content-Type: application/json" \
            -G \
            --data-urlencode "expires_at=$EXPIRES_AT" \
            --data-urlencode "description=Access token for default backend" \
            --data-urlencode "roles=osmo-backend" \
            $BASE_URL/api/auth/access_token/service/backend-operator-token)

          CURL_EXIT_CODE=$?
          if [ $CURL_EXIT_CODE -ne 0 ]; then
            echo "Failed to create token (curl exit code: $CURL_EXIT_CODE): $TOKEN_RESPONSE"
            exit 1
          fi

          if echo "$TOKEN_RESPONSE" | jq -e . >/dev/null 2>&1; then
            echo "DEBUG: Response is JSON"
            if echo "$TOKEN_RESPONSE" | jq -e 'type == "object"' >/dev/null 2>&1; then
              echo "DEBUG: JSON object detected, extracting .token field..."
              TOKEN=$(echo "$TOKEN_RESPONSE" | jq -r '.token // empty')
            else
              echo "DEBUG: JSON string detected, parsing as string..."
              TOKEN=$(echo "$TOKEN_RESPONSE" | jq -r '.')
            fi
          else
            echo "DEBUG: Response is plain text"
            TOKEN="$TOKEN_RESPONSE"
          fi

          if [ -z "$TOKEN" ] || [ "$TOKEN" = "null" ]; then
            echo "Failed to extract token from response: $TOKEN_RESPONSE"
            exit 1
          fi

          echo "DEBUG: Created service token successfully: [${#TOKEN} chars]"

          echo "Creating Kubernetes secret backend-operator-token..."
          kubectl create secret generic backend-operator-token \
            --from-literal=token="$TOKEN" \
            -n {{ .Release.Namespace }} \
            --dry-run=client -o yaml | kubectl apply -f -

          # Verify secret was created
          if ! kubectl get secret backend-operator-token -n {{ .Release.Namespace }} >/dev/null 2>&1; then
            echo "Failed to create backend-operator-token secret"
            exit 1
          fi


          echo "Created backend-operator-token secret successfully"
      serviceAccountName: {{ .Release.Namespace }}-agent-token-generator
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: {{ .Release.Namespace }}-agent-token-generator
  namespace: {{ .Release.Namespace }}
  annotations:
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-weight": "10"
    "helm.sh/hook-delete-policy": before-hook-creation
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: {{ .Release.Namespace }}-agent-token-generator
  namespace: {{ .Release.Namespace }}
  annotations:
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-weight": "10"
    "helm.sh/hook-delete-policy": before-hook-creation
rules:
- apiGroups: [""]
  resources: ["secrets"]
  verbs: ["create", "get", "patch", "update", "delete"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: {{ .Release.Namespace }}-agent-token-generator
  namespace: {{ .Release.Namespace }}
  annotations:
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-weight": "10"
    "helm.sh/hook-delete-policy": before-hook-creation
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: {{ .Release.Namespace }}-agent-token-generator
subjects:
- kind: ServiceAccount
  name: {{ .Release.Namespace }}-agent-token-generator
  namespace: {{ .Release.Namespace }}
