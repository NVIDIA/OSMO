<!--
SPDX-FileCopyrightText: Copyright (c) 2026 NVIDIA CORPORATION. All rights reserved.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.

SPDX-License-Identifier: Apache-2.0
-->

<!-- üö® AGENT: The CRITICAL section below contains NON-NEGOTIABLE rules. Verify compliance before writing ANY code. -->

# OSMO UI Rules

> Next.js 15, React 19, TailwindCSS 4, TanStack Query/Table/Virtual, Zustand, nuqs, shadcn/ui

---

## üö® CRITICAL - STOP AND CHECK BEFORE EVERY ACTION

**These 5 rules are NON-NEGOTIABLE. Verify each one before writing code:**

| Before You... | STOP and CHECK | Violation = Rejected Code |
|---------------|----------------|---------------------------|
| Create a component | Search `@/components/` - does it exist? | Creating duplicate components |
| Import a type | Is it from `@/lib/api/adapter`? | Importing from `generated.ts` |
| Add a hook | Check `@/hooks/` and `usehooks-ts` first | Reinventing existing hooks |
| Fetch data | Using TanStack Query via adapter? | useState + useEffect + fetch |
| Make something clickable | Using `<Button>` or semantic HTML? | `<div onClick>` or `<span onClick>` |

---

## FORBIDDEN PATTERNS - HARD STOPS

You MUST NOT do these. They will break the codebase:

```tsx
// ‚ùå FORBIDDEN: Deep imports bypass public API
import { usePoolsData } from "@/app/(dashboard)/pools/hooks/use-pools-data";

// ‚úÖ REQUIRED: Import from feature's public API (index.ts)
import { usePoolsData } from "@/app/(dashboard)/pools";
```

```tsx
// ‚ùå FORBIDDEN: Types from generated change without notice
import type { Pool } from "@/lib/api/generated";

// ‚úÖ REQUIRED: Types from adapter are stable
import type { Pool } from "@/lib/api/adapter";
```

```tsx
// ‚ùå FORBIDDEN: String literals for enums
if (pool.status === "ONLINE") { ... }
if (workflow.priority === "HIGH") { ... }
const statuses = ["RUNNING", "COMPLETED"];

// ‚úÖ REQUIRED: Use generated enums for type safety
import { PoolStatus, WorkflowStatus, WorkflowPriority } from "@/lib/api/generated";
if (pool.status === PoolStatus.ONLINE) { ... }
if (workflow.priority === WorkflowPriority.HIGH) { ... }
const statuses = [WorkflowStatus.RUNNING, WorkflowStatus.COMPLETED];
```

```tsx
// ‚ùå FORBIDDEN: Manual fetch patterns
const [data, setData] = useState(null);
const [loading, setLoading] = useState(true);
useEffect(() => { fetch(...).then(setData); }, []);

// ‚úÖ REQUIRED: TanStack Query via adapter hooks
const { pools, isLoading, error } = usePools();
```

```tsx
// ‚ùå FORBIDDEN: Non-semantic interactive elements
<div onClick={handleClick}>Click me</div>
<span role="button" onClick={handleClick}>Action</span>

// ‚úÖ REQUIRED: Semantic HTML or shadcn components
<Button onClick={handleClick}>Click me</Button>
<button onClick={handleClick}>Action</button>
```

---

## REQUIRED - Check These Locations First

Before creating ANYTHING, search these directories:

| Need | Check First | Common Files |
|------|-------------|--------------|
| UI primitives | `@/components/shadcn/` | button, dialog, input, select, tooltip, popover |
| Composed components | `@/components/` | DataTable, SmartSearch, Panel, TableToolbar |
| Hooks | `@/hooks/` | useCopy, useAnnouncer, useServices, usePanelState |
| Table stores | `@/stores/` | createTableStore factory |
| Utilities | `@/lib/utils.ts` | cn, formatters, validators |
| Library hooks | `usehooks-ts`, `@react-hookz/web` | useDebounce, useLocalStorage, etc. |

**Rule: If it exists, USE it. If it's close, EXTEND it. Only then CREATE.**

---

## Single Source of Truth

NEVER hardcode these values. ALWAYS use the designated source:

| What | Source | NOT |
|------|--------|-----|
| Row heights, spacing | `useConfig()` ‚Üí `table.rowHeights` | Magic numbers like `48` |
| Panel widths | `useConfig()` ‚Üí `panel.*` | Hardcoded `320px` |
| API types | `@/lib/api/adapter/` | `@/lib/api/generated.ts` |
| Enums ONLY | `@/lib/api/generated.ts` | String literals |
| Status enums | `WorkflowStatus`, `TaskGroupStatus`, `PoolStatus` | `"RUNNING"`, `"ONLINE"` |
| Priority enum | `WorkflowPriority` | `"HIGH"`, `"NORMAL"`, `"LOW"` |
| CSS variables | `globals.css` | Inline hex colors |
| Feature constants | `feature/lib/constants.ts` | Scattered magic strings |
| Column configs | `feature/lib/feature-columns.ts` | Inline column definitions |
| Clipboard operations | `useServices().clipboard` | `navigator.clipboard` directly |
| Screen reader announcements | `useServices().announcer` | Manual aria-live regions |
| URL state | `usePanelState()`, `useUrlChips()` | Raw `useSearchParams` |

---

## üîê Backend Type Coupling - CRITICAL

The UI MUST be tightly coupled to generated backend types. This ensures a single source of truth.

### Enums: ALWAYS Import from Generated

```tsx
// ‚ùå FORBIDDEN: Defining your own enum-like types
type Priority = "HIGH" | "NORMAL" | "LOW";
type Status = "ONLINE" | "OFFLINE";
const statuses = ["RUNNING", "COMPLETED"] as const;

// ‚úÖ REQUIRED: Derive from generated enums
import { WorkflowPriority, WorkflowStatus, PoolStatus } from "@/lib/api/generated";
type Priority = (typeof WorkflowPriority)[keyof typeof WorkflowPriority];
const statuses = [WorkflowStatus.RUNNING, WorkflowStatus.COMPLETED];
```

### Status/Enum Arrays: ALWAYS Derive from Generated

```tsx
// ‚ùå FORBIDDEN: Hardcoded arrays of enum values
const ALL_STATUSES = ["PENDING", "RUNNING", "COMPLETED", "FAILED"];
const FAILED_STATUSES = ["FAILED", "FAILED_TIMEOUT", "FAILED_CANCELED"];

// ‚úÖ REQUIRED: Derive from generated enum
import { WorkflowStatus } from "@/lib/api/generated";
const ALL_STATUSES = Object.values(WorkflowStatus);
const FAILED_STATUSES = [
  WorkflowStatus.FAILED,
  WorkflowStatus.FAILED_EXEC_TIMEOUT,
  WorkflowStatus.FAILED_CANCELED,
];
```

### Record Keys: Use Computed Properties with Enums

```tsx
// ‚ùå FORBIDDEN: String literal keys in Records
const STATUS_LABELS: Record<string, string> = {
  "ONLINE": "Online",
  "OFFLINE": "Offline",
};

// ‚úÖ REQUIRED: Computed property names with enum values
import { PoolStatus } from "@/lib/api/generated";
const STATUS_LABELS: Record<PoolStatus, string> = {
  [PoolStatus.ONLINE]: "Online",
  [PoolStatus.OFFLINE]: "Offline",
  [PoolStatus.MAINTENANCE]: "Maintenance",
};
```

### Test Factories: Use Enum Values

```tsx
// ‚ùå FORBIDDEN: String literals in test data
const pool = createMockPool({ status: "ONLINE" });
const workflow = createMockWorkflow({ priority: "HIGH" });

// ‚úÖ REQUIRED: Enum values for type safety
import { PoolStatus, WorkflowPriority } from "@/lib/api/generated";
const pool = createMockPool({ status: PoolStatus.ONLINE });
const workflow = createMockWorkflow({ priority: WorkflowPriority.HIGH });
```

### Available Generated Enums

| Enum | Values | Use For |
|------|--------|---------|
| `PoolStatus` | ONLINE, OFFLINE, MAINTENANCE | Pool status filtering/display |
| `WorkflowStatus` | PENDING, RUNNING, COMPLETED, FAILED_* (16 values) | Workflow status |
| `TaskGroupStatus` | WAITING, RUNNING, COMPLETED, FAILED_* (18 values) | Task/group status |
| `WorkflowPriority` | HIGH, NORMAL, LOW | Workflow priority |
| `BackendResourceType` | RESERVED, SHARED, UNUSED | Resource type |
| `DatasetStatus` | Various | Dataset status |

**WHY THIS MATTERS:**
- Backend adds a new status ‚Üí TypeScript error forces UI update
- No silent failures from typos (`"RUNING"` vs `"RUNNING"`)
- Refactoring is safe (rename in one place, compiler finds all uses)
- `pnpm generate-api` keeps everything in sync

---

## Delegate to Libraries - NEVER Reimplement

| Need | MUST Use | NEVER Do |
|------|----------|----------|
| Data fetching/caching | TanStack Query | useState + useEffect + fetch |
| Table sort/filter/pagination | TanStack Table | Manual array.sort/filter |
| Virtual scrolling | TanStack Virtual | Custom scroll handlers |
| Form state + validation | React Hook Form + Zod | Custom form reducers |
| URL query state | nuqs | Custom useSearchParams wrappers |
| Client state | Zustand stores | Context + useReducer |
| UI primitives | shadcn/ui | Custom buttons, dialogs, inputs |

---

## Architecture

```
Page ‚Üí Headless Hook ‚Üí Adapter Hook ‚Üí Generated API
           ‚Üì
    Components (receive data as props, NEVER fetch internally)
```

**Key principle:** Components are PURE. They receive data as props and render it. They do NOT fetch data.

---

## Feature Structure

Every feature follows this structure:

```
feature/
‚îú‚îÄ‚îÄ index.ts              # PUBLIC API - ONLY export from here
‚îú‚îÄ‚îÄ page.tsx              # Next.js page component
‚îú‚îÄ‚îÄ hooks/
‚îÇ   ‚îî‚îÄ‚îÄ use-feature-data.ts
‚îú‚îÄ‚îÄ lib/
‚îÇ   ‚îú‚îÄ‚îÄ constants.ts      # Feature-specific constants
‚îÇ   ‚îú‚îÄ‚îÄ feature-columns.ts
‚îÇ   ‚îú‚îÄ‚îÄ transforms.ts     # Pure transform functions
‚îÇ   ‚îî‚îÄ‚îÄ transforms.test.ts # Co-located tests
‚îú‚îÄ‚îÄ components/
‚îÇ   ‚îî‚îÄ‚îÄ FeatureTable.tsx
‚îî‚îÄ‚îÄ stores/
    ‚îî‚îÄ‚îÄ feature-table-store.ts
```

---

## State Management Patterns

```tsx
// Server state ‚Üí TanStack Query (via adapter)
const { pools, isLoading, error } = usePools();

// Table UI state ‚Üí Zustand
const { visibleColumnIds, setVisibleColumnIds } = usePoolsTableStore();

// URL state ‚Üí nuqs (via consolidated hooks)
const { selection, setSelection, clear } = usePanelState();

// App config ‚Üí Context
const { table } = useConfig();
```

---

## Consolidated Patterns - USE THESE

```tsx
// URL-synced panel state
const { selection, setSelection, clear } = usePanelState();

// Results count with filter awareness
const resultsCount = useResultsCount({ total, filteredTotal, hasActiveFilters });

// Table loading/error states
if (isLoading) return <TableLoadingSkeleton rowHeight={rowHeight} />;
if (error) return <TableErrorState error={error} title="Unable to load pools" onRetry={refetch} />;

// Chip-based filtering
const filterParams = chipsToParams(searchChips, POOL_CHIP_MAPPING);
```

---

## Adapter Pattern

The adapter layer isolates UI from backend quirks. UI expects ideal types:

```tsx
// src/lib/api/adapter/hooks.ts
export function usePools() {
  const query = useGetApiPools(); // generated hook
  return {
    pools: query.data?.pools?.map(transformPool) ?? [],
    isLoading: query.isLoading,
    error: query.error,
    refetch: query.refetch,
  };
}
```

**Document backend issues in `BACKEND_TODOS.md`, not as UI workarounds.**

---

## Composition Pattern

```tsx
// ‚úÖ CORRECT: Compose shadcn primitives
import { Button } from "@/components/shadcn/button";
import { Tooltip, TooltipTrigger, TooltipContent } from "@/components/shadcn/tooltip";

export function CopyButton({ text }: { text: string }) {
  const { copy, copied } = useCopy();
  return (
    <Tooltip>
      <TooltipTrigger asChild>
        <Button variant="ghost" size="icon" onClick={() => copy(text)}>
          {copied ? <Check /> : <Copy />}
        </Button>
      </TooltipTrigger>
      <TooltipContent>{copied ? "Copied!" : "Copy"}</TooltipContent>
    </Tooltip>
  );
}
```

```tsx
// ‚ùå FORBIDDEN: Building from scratch
<button className="custom-btn px-4 py-2 bg-blue-500...">...</button>
```

---

## Accessibility Requirements

All interactive elements MUST be keyboard accessible:

- **Enter/Space**: Activate buttons and controls
- **Arrow keys**: Navigate within composite widgets
- **Escape**: Close modals, cancel operations
- **Tab**: Move between focusable elements

```tsx
// ‚úÖ REQUIRED: Screen reader announcements for dynamic changes
const { announcer } = useServices();
await clipboard.copy(text);
announcer.announce("Copied to clipboard", "polite");
```

```tsx
// ‚úÖ REQUIRED: Focus visible styling
<Button className="focus-nvidia">...</Button>
```

---

## Performance Requirements

| Scenario | MUST Use | Reason |
|----------|----------|--------|
| Lists > 50 items | TanStack Virtual + `contain-strict` | Prevent DOM bloat |
| Search inputs | `useDeferredValue` | Don't block typing |
| Heavy state updates | `startTransition` | Keep UI responsive |
| Scroll containers | `overscroll-behavior: contain` | Prevent scroll chaining |

```tsx
// Virtual list container
<div
  className="contain-strict content-visibility-auto"
  style={{ containIntrinsicSize: 'auto 48px' }}
>
  {virtualRows.map(...)}
</div>
```

**Animation rules:**
- ‚úÖ Animate: `transform`, `opacity` (GPU-accelerated)
- ‚ùå NEVER animate: `width`, `height`, `margin`, `padding` (causes reflow)

---

## Testing

Unit test pure functions. Co-locate tests with source:

```
lib/
‚îú‚îÄ‚îÄ transforms.ts
‚îî‚îÄ‚îÄ transforms.test.ts
```

```bash
pnpm test              # Run all tests
pnpm test:watch        # Watch mode for development
```

---

## Commands

```bash
pnpm dev               # Development server
pnpm dev:mock          # Mock data mode (no backend required)
pnpm generate-api      # Regenerate API types from OpenAPI spec
pnpm type-check        # TypeScript type checking
pnpm lint              # ESLint
pnpm test              # Run unit tests
```

---

## Pre-Commit Checklist

```bash
# REQUIRED before committing:
pnpm type-check && pnpm lint && pnpm test && pnpm build
```

**When fixing errors:**
- ‚ùå NEVER suppress with `@ts-ignore` or `eslint-disable`
- ‚ùå NEVER use `any` type
- ‚úÖ ALWAYS resolve the root cause properly

---

## üîç Final Verification - ASK YOURSELF

Before submitting any code, verify:

- [ ] Did I check `@/components/` before creating a new component?
- [ ] Are ALL imports from public APIs (`index.ts` exports)?
- [ ] Are types from `@/lib/api/adapter`, enums from `@/lib/api/generated`?
- [ ] Am I using enum values (e.g., `PoolStatus.ONLINE`) instead of string literals (`"ONLINE"`)?
- [ ] Are any type definitions duplicating what exists in `generated.ts`?
- [ ] Is every interactive element keyboard accessible?
- [ ] Did I use TanStack/Zustand/nuqs instead of manual state?
- [ ] Are there any magic numbers that should be constants or config values?
- [ ] Does the new file have the NVIDIA copyright header?

**If any answer is NO, fix it before proceeding.**
