/* Copyright (c) 2025, NVIDIA CORPORATION. All rights reserved.
 *
 * NVIDIA CORPORATION and its licensors retain all intellectual property
 * and proprietary rights in and to this software, related documentation
 * and any modifications thereto. Any use, reproduction, disclosure or
 * distribution of this software and related documentation without an express
 * license agreement from NVIDIA CORPORATION is strictly prohibited.
 */

/**
 * DAG Visualization Styles
 *
 * This stylesheet provides:
 * - CSS custom properties for theming (status colors, dimensions)
 * - Light/dark mode support via .dark class (next-themes compatible)
 * - GPU-accelerated styling via transform/will-change
 * - Data-attribute styling for status (avoids JS style recalculation)
 * - ReactFlow overrides
 * - Relative units (rem/em) for scalability
 *
 * THEMING:
 * - Uses CSS custom properties that change based on .dark class
 * - Components should use these variables for consistent theming
 * - Tailwind classes should use dark: prefix for mode-specific styles
 *
 * PERFORMANCE NOTES:
 * - Uses CSS containment (contain: layout style) to isolate calculations
 * - GPU layers via translateZ(0) for smooth transforms
 * - Prefers data-attribute selectors over JS-driven className changes
 * - Respects prefers-reduced-motion for accessibility
 */

/* ==========================================================================
   CSS Custom Properties - Light mode (default)
   ========================================================================== */

:root {
  /* Canvas colors */
  --dag-canvas-bg: oklch(0.985 0 0);
  --dag-canvas-dots: oklch(0.85 0 0);

  /* Surface colors */
  --dag-surface: oklch(1 0 0);
  --dag-surface-elevated: oklch(0.98 0 0);
  --dag-surface-hover: oklch(0.96 0 0);
  --dag-surface-selected: oklch(0.94 0 0);

  /* Border colors */
  --dag-border: oklch(0.9 0 0);
  --dag-border-subtle: oklch(0.92 0 0);
  --dag-border-strong: oklch(0.8 0 0);

  /* Text colors */
  --dag-text: oklch(0.2 0 0);
  --dag-text-secondary: oklch(0.45 0 0);
  --dag-text-tertiary: oklch(0.6 0 0);
  --dag-text-inverted: oklch(0.98 0 0);

  /* Status colors - Light mode (more vibrant) */
  --dag-status-waiting-bg: oklch(0.96 0 0);
  --dag-status-waiting-border: oklch(0.8 0 0);
  --dag-status-waiting-text: oklch(0.5 0 0);
  --dag-status-waiting-color: oklch(0.6 0 0);

  --dag-status-running-bg: oklch(0.95 0.04 250);
  --dag-status-running-border: oklch(0.6 0.15 250);
  --dag-status-running-text: oklch(0.45 0.15 250);
  --dag-status-running-color: oklch(0.55 0.18 250);

  --dag-status-completed-bg: oklch(0.95 0.04 160);
  --dag-status-completed-border: oklch(0.6 0.12 160);
  --dag-status-completed-text: oklch(0.4 0.12 160);
  --dag-status-completed-color: oklch(0.55 0.15 160);

  --dag-status-failed-bg: oklch(0.95 0.04 25);
  --dag-status-failed-border: oklch(0.6 0.18 25);
  --dag-status-failed-text: oklch(0.45 0.18 25);
  --dag-status-failed-color: oklch(0.55 0.2 25);

  /* Handle colors */
  --dag-handle-bg: oklch(0.7 0 0);
  --dag-handle-border: oklch(0.6 0 0);

  /* Selection */
  --dag-selection-ring: oklch(0.6 0.15 250);

  /* Scrollbar */
  --dag-scrollbar-thumb: oklch(0.75 0 0);
  --dag-scrollbar-thumb-hover: oklch(0.65 0 0);

  /* Controls */
  --dag-controls-bg: oklch(0.98 0 0);
  --dag-controls-border: oklch(0.9 0 0);
  --dag-controls-text: oklch(0.4 0 0);
  --dag-controls-hover: oklch(0.94 0 0);

  /* Minimap */
  --dag-minimap-bg: oklch(0.96 0 0);
  --dag-minimap-mask: oklch(0.5 0 0 / 0.2);

  /* Node dimensions (rem-based for scalability) */
  --dag-node-collapsed-width: 11.25rem;
  --dag-node-collapsed-height: 4.5rem;
  --dag-node-expanded-width: 15rem;
  --dag-node-max-height: 20rem;
  --dag-node-header-height: 3.5rem;
  --dag-task-row-height: 1.75rem;

  /* Edge styling */
  --dag-edge-stroke-width: 0.125rem;
  --dag-edge-dash-array: 5 3;

  /* Panel dimensions */
  --dag-panel-min-width: 20rem;
  --dag-panel-max-width: 30rem;
  --dag-panel-shadow: -0.25rem 0 1rem -0.25rem rgba(0, 0, 0, 0.1);

  /* Handle sizes */
  --dag-handle-size: 0.5rem;

  /* Transitions */
  --dag-transition-fast: 75ms ease-out;
  --dag-transition-normal: 150ms ease-out;
  --dag-transition-slow: 300ms ease-out;

  /* Border radius */
  --dag-radius-sm: 0.25rem;
  --dag-radius-md: 0.5rem;
  --dag-radius-lg: 0.75rem;
}

/* ==========================================================================
   CSS Custom Properties - Dark mode
   ========================================================================== */

.dark {
  /* Canvas colors */
  --dag-canvas-bg: oklch(0.12 0 0);
  --dag-canvas-dots: oklch(0.25 0 0);

  /* Surface colors */
  --dag-surface: oklch(0.16 0 0);
  --dag-surface-elevated: oklch(0.2 0 0);
  --dag-surface-hover: oklch(0.22 0 0);
  --dag-surface-selected: oklch(0.25 0 0);

  /* Border colors */
  --dag-border: oklch(0.28 0 0);
  --dag-border-subtle: oklch(0.24 0 0);
  --dag-border-strong: oklch(0.35 0 0);

  /* Text colors */
  --dag-text: oklch(0.95 0 0);
  --dag-text-secondary: oklch(0.7 0 0);
  --dag-text-tertiary: oklch(0.5 0 0);
  --dag-text-inverted: oklch(0.1 0 0);

  /* Status colors - Dark mode */
  --dag-status-waiting-bg: oklch(0.27 0 0 / 0.6);
  --dag-status-waiting-border: oklch(0.37 0 0);
  --dag-status-waiting-text: oklch(0.64 0 0);
  --dag-status-waiting-color: oklch(0.47 0 0);

  --dag-status-running-bg: oklch(0.25 0.07 250 / 0.6);
  --dag-status-running-border: oklch(0.55 0.15 250);
  --dag-status-running-text: oklch(0.7 0.12 250);
  --dag-status-running-color: oklch(0.55 0.15 250);

  --dag-status-completed-bg: oklch(0.3 0.08 160 / 0.6);
  --dag-status-completed-border: oklch(0.55 0.12 160);
  --dag-status-completed-text: oklch(0.7 0.14 160);
  --dag-status-completed-color: oklch(0.65 0.16 160);

  --dag-status-failed-bg: oklch(0.28 0.08 25 / 0.6);
  --dag-status-failed-border: oklch(0.55 0.2 25);
  --dag-status-failed-text: oklch(0.7 0.18 25);
  --dag-status-failed-color: oklch(0.55 0.2 25);

  /* Handle colors */
  --dag-handle-bg: oklch(0.4 0 0);
  --dag-handle-border: oklch(0.5 0 0);

  /* Selection */
  --dag-selection-ring: oklch(0.7 0.15 195);

  /* Scrollbar */
  --dag-scrollbar-thumb: oklch(0.4 0 0);
  --dag-scrollbar-thumb-hover: oklch(0.5 0 0);

  /* Controls */
  --dag-controls-bg: oklch(0.2 0 0);
  --dag-controls-border: oklch(0.3 0 0);
  --dag-controls-text: oklch(0.64 0 0);
  --dag-controls-hover: oklch(0.3 0 0);

  /* Minimap */
  --dag-minimap-bg: oklch(0.13 0 0);
  --dag-minimap-mask: oklch(0 0 0 / 0.6);

  /* Panel shadow - darker in dark mode */
  --dag-panel-shadow: -0.25rem 0 1rem -0.25rem rgba(0, 0, 0, 0.3);
}

/* ==========================================================================
   Node Status Styling via data-attributes (no JS style recalculation)
   ========================================================================== */

.dag-node {
  /* GPU acceleration - composite layer */
  transform: translateZ(0);
  will-change: transform;

  /* Allow handles to overflow outside the node */
  overflow: visible;

  /* Card-like shadow for depth */
  box-shadow:
    0 1px 2px rgba(0, 0, 0, 0.06),
    0 2px 4px rgba(0, 0, 0, 0.06);

  /* Smooth transitions using GPU-accelerated properties only */
  transition:
    box-shadow var(--dag-transition-normal),
    border-color var(--dag-transition-normal);
}

.dark .dag-node {
  box-shadow:
    0 1px 2px rgba(0, 0, 0, 0.2),
    0 2px 4px rgba(0, 0, 0, 0.15);
}

.dag-node[data-status="waiting"] {
  background: var(--dag-status-waiting-bg);
  border-color: var(--dag-status-waiting-border);
}

.dag-node[data-status="running"] {
  background: var(--dag-status-running-bg);
  border-color: var(--dag-status-running-border);
}

.dag-node[data-status="completed"] {
  background: var(--dag-status-completed-bg);
  border-color: var(--dag-status-completed-border);
}

.dag-node[data-status="failed"] {
  background: var(--dag-status-failed-bg);
  border-color: var(--dag-status-failed-border);
}

/* Status text colors for node hints */
.dag-node[data-status="waiting"] .dag-node-hint {
  color: var(--dag-status-waiting-text);
}
.dag-node[data-status="running"] .dag-node-hint {
  color: var(--dag-status-running-text);
}
.dag-node[data-status="completed"] .dag-node-hint {
  color: var(--dag-status-completed-text);
}
.dag-node[data-status="failed"] .dag-node-hint {
  color: var(--dag-status-failed-text);
}

/* Status text colors for task row durations */
.dag-task-row[data-status="waiting"] .dag-task-duration {
  color: var(--dag-status-waiting-text);
}
.dag-task-row[data-status="running"] .dag-task-duration {
  color: var(--dag-status-running-text);
}
.dag-task-row[data-status="completed"] .dag-task-duration {
  color: var(--dag-status-completed-text);
}
.dag-task-row[data-status="failed"] .dag-task-duration {
  color: var(--dag-status-failed-text);
}

/* Task rows - GPU-accelerated positioning */
.dag-task-row {
  will-change: transform;
  isolation: isolate;
}

/* ==========================================================================
   Virtualized scroll container optimization
   ========================================================================== */

.dag-scroll-container {
  /* GPU layer for smooth scrolling */
  transform: translateZ(0);
  /* Optimize scroll performance */
  -webkit-overflow-scrolling: touch;
  scrollbar-width: thin;
  scrollbar-color: var(--dag-scrollbar-thumb) transparent;
}

.dag-scroll-container::-webkit-scrollbar {
  width: 0.375rem;
}

.dag-scroll-container::-webkit-scrollbar-track {
  background: transparent;
}

.dag-scroll-container::-webkit-scrollbar-thumb {
  background: var(--dag-scrollbar-thumb);
  border-radius: var(--dag-radius-sm);
}

.dag-scroll-container::-webkit-scrollbar-thumb:hover {
  background: var(--dag-scrollbar-thumb-hover);
}


/* Selection state - pure CSS, no JS re-render needed */
.dag-node[data-selected="true"] {
  outline: 2px solid var(--dag-selection-ring);
  outline-offset: 2px;
  box-shadow:
    0 2px 4px rgba(0, 0, 0, 0.08),
    0 4px 8px rgba(0, 0, 0, 0.08);
}

.dark .dag-node[data-selected="true"] {
  box-shadow:
    0 2px 4px rgba(0, 0, 0, 0.25),
    0 4px 8px rgba(0, 0, 0, 0.2);
}

/* ==========================================================================
   Connection Handles - positioned outside the node
   ========================================================================== */

.dag-handle {
  /* Size using custom property */
  width: var(--dag-handle-size) !important;
  height: var(--dag-handle-size) !important;
  min-width: var(--dag-handle-size) !important;
  min-height: var(--dag-handle-size) !important;

  /* Appearance */
  background: var(--dag-handle-bg) !important;
  border: 1.5px solid var(--dag-handle-border) !important;
  border-radius: 50% !important;

  /* GPU layer */
  transform: translateZ(0);
}

/* ==========================================================================
   ReactFlow Canvas Optimization
   ========================================================================== */

/* GPU-accelerate the entire canvas */
.react-flow__viewport {
  will-change: transform;
}

/* Nodes container - GPU layer */
.react-flow__nodes {
  will-change: transform;
}

/* Individual node wrappers */
.react-flow__node {
  will-change: transform;
  contain: layout style;
}

/* ==========================================================================
   Edge Styling via CSS (class-based, no inline styles)
   ========================================================================== */

.react-flow__edge-path {
  stroke-width: var(--dag-edge-stroke-width);
  transition: stroke var(--dag-transition-normal);
  vector-effect: non-scaling-stroke;
}

/* Edge status coloring via class names */
.dag-edge.dag-edge--waiting path {
  stroke: var(--dag-status-waiting-color);
}

.dag-edge.dag-edge--running path {
  stroke: var(--dag-status-running-color);
}

.dag-edge.dag-edge--completed path {
  stroke: var(--dag-status-completed-color);
}

.dag-edge.dag-edge--failed path {
  stroke: var(--dag-status-failed-color);
}

/* Edge animation - GPU-accelerated using stroke-dashoffset */
.react-flow__edge.animated path {
  stroke-dasharray: 5;
  animation: dag-edge-flow 0.5s linear infinite;
}

@keyframes dag-edge-flow {
  to {
    stroke-dashoffset: -10;
  }
}

/* ==========================================================================
   Reduced Motion - Accessibility
   ========================================================================== */

@media (prefers-reduced-motion: reduce) {
  .dag-node,
  .react-flow__edge-path {
    transition: none;
  }

  .react-flow__edge.animated path {
    animation: none;
  }

  /* Disable all transforms that aren't for positioning */
  .dag-node,
  .dag-task-row {
    will-change: auto;
  }
}

/* ==========================================================================
   ReactFlow Controls and Minimap - Theme-aware
   ========================================================================== */

/* Controls panel */
.react-flow__controls {
  background: var(--dag-controls-bg);
  border: 1px solid var(--dag-controls-border);
  border-radius: var(--dag-radius-md);
  box-shadow: 0 0.25rem 0.375rem -0.0625rem rgba(0, 0, 0, 0.1);
}

.dark .react-flow__controls {
  box-shadow: 0 0.25rem 0.375rem -0.0625rem rgba(0, 0, 0, 0.3);
}

.react-flow__controls-button {
  background: var(--dag-controls-bg);
  border: none;
  border-bottom: 1px solid var(--dag-controls-border);
  fill: var(--dag-controls-text);
  color: var(--dag-controls-text);
}

.react-flow__controls-button:hover {
  background: var(--dag-controls-hover);
}

.react-flow__controls-button:last-child {
  border-bottom: none;
}

.react-flow__controls-button svg {
  fill: currentColor;
}

/* Minimap */
.react-flow__minimap {
  background: var(--dag-minimap-bg);
  border: 1px solid var(--dag-controls-border);
  border-radius: var(--dag-radius-md);
  box-shadow: 0 0.25rem 0.375rem -0.0625rem rgba(0, 0, 0, 0.1);
}

.dark .react-flow__minimap {
  box-shadow: 0 0.25rem 0.375rem -0.0625rem rgba(0, 0, 0, 0.3);
}

.react-flow__minimap-mask {
  fill: var(--dag-minimap-mask);
}

/* Attribution - hide or style */
.react-flow__attribution {
  background: transparent;
}

.react-flow__attribution a {
  color: var(--dag-text-tertiary);
}

/* ==========================================================================
   Panel Styles
   ========================================================================== */

.dag-panel {
  contain: layout style;
  box-shadow: var(--dag-panel-shadow);
}

/* ==========================================================================
   Table Styles (for GroupPanel)
   ========================================================================== */

.dag-table-header {
  contain: layout style;
  position: sticky;
  top: 0;
  z-index: 10;
}

.dag-table-row {
  contain: layout style paint;
  transition: background-color var(--dag-transition-fast);
}

.dag-table-row:hover {
  background-color: var(--dag-surface-hover);
}

/* ==========================================================================
   Resize Handle
   ========================================================================== */

.dag-resize-handle {
  touch-action: none;
  user-select: none;
}

.dag-resize-handle::before {
  content: "";
  position: absolute;
  inset: -0.5rem;
}

/* ==========================================================================
   GPU Acceleration Utility Classes
   ========================================================================== */

/**
 * Base GPU acceleration - promotes element to its own composite layer.
 * Use for elements that will be animated or frequently transformed.
 */
.dag-gpu-accelerated {
  transform: translate3d(0, 0, 0);
  will-change: transform;
  backface-visibility: hidden;
}

/**
 * Strict containment - maximum layout isolation.
 * Use for table rows, list items, cards that don't affect siblings.
 */
.dag-contained {
  contain: layout style paint;
}

/**
 * Strict containment for virtual list items.
 * Maximum isolation + content-visibility optimization.
 */
.dag-virtual-item {
  contain: strict;
  content-visibility: auto;
}

/**
 * Layout + style containment only (allows paint overflow).
 * Use for panels, dropdowns, modals.
 */
.dag-contained-layout {
  contain: layout style;
}

/* ==========================================================================
   Panel Containers with GPU Acceleration
   ========================================================================== */

.dag-details-panel {
  transform: translate3d(0, 0, 0);
  will-change: transform;
  backface-visibility: hidden;
  contain: layout style;
}

.dag-details-panel-handle {
  transform: translate3d(0, 0, 0);
  will-change: transform;
  backface-visibility: hidden;
}

/* ==========================================================================
   Table Components
   ========================================================================== */

.dag-table-container {
  transform: translate3d(0, 0, 0);
  will-change: transform;
  backface-visibility: hidden;
}

.dag-table-header-wrapper {
  contain: layout style paint;
}

.dag-table-virtual-container {
  transform: translate3d(0, 0, 0);
  will-change: transform;
  backface-visibility: hidden;
}

/* ==========================================================================
   Dropdown/Popover Components
   ========================================================================== */

.dag-dropdown {
  transform: translate3d(0, 0, 0);
  will-change: transform;
  backface-visibility: hidden;
  contain: layout style;
}

/* ==========================================================================
   Group Details - Timeline Styles
   ========================================================================== */

/* Timeline markers - use status colors for consistency */
.timeline-marker-completed {
  background-color: var(--dag-status-completed-color);
  border-color: var(--dag-status-completed-color);
}

.timeline-marker-running {
  background-color: var(--dag-status-running-color);
  border-color: var(--dag-status-running-color);
}

.timeline-marker-failed {
  background-color: var(--dag-status-failed-color);
  border-color: var(--dag-status-failed-color);
}

.timeline-marker-pending {
  background-color: var(--dag-surface-elevated);
  border-color: var(--dag-border-strong);
}

/* Timeline segments */
.timeline-segment-completed {
  background-color: var(--dag-status-completed-color);
}

/* Active timeline segment with gradient animation using running status color */
.timeline-active-segment {
  background: linear-gradient(
    90deg,
    var(--dag-status-running-color) 0%,
    var(--dag-status-running-border) 50%,
    var(--dag-status-running-color) 100%
  );
  background-size: 200% 100%;
  animation: timeline-pulse 2s ease-in-out infinite;
}

@keyframes timeline-pulse {
  0%,
  100% {
    background-position: 0% 50%;
  }
  50% {
    background-position: 100% 50%;
  }
}

/* Timeline text labels */
.timeline-text-completed {
  color: var(--dag-status-completed-text);
}

.timeline-text-running {
  color: var(--dag-status-running-text);
}

.timeline-text-failed {
  color: var(--dag-status-failed-text);
}

.timeline-text-pending {
  color: var(--dag-text-tertiary);
}

/* Reduce motion for accessibility */
@media (prefers-reduced-motion: reduce) {
  .timeline-active-segment {
    animation: none;
    background: var(--dag-status-running-color);
  }
}

/* ==========================================================================
   Group Details - Dependency Pills
   ========================================================================== */

/* Dependency pill row container */
.dependency-pills-row {
  contain: layout style;
}

/* Pill base styles */
.dependency-pill {
  transition:
    filter var(--dag-transition-fast),
    transform var(--dag-transition-fast);
}

/* Pill hover effect */
.dependency-pill:hover {
  filter: brightness(1.1);
}

.dependency-pill:active {
  transform: scale(0.98);
}

/* Status-specific pill styling using CSS variables */
.dependency-pill-completed {
  background-color: var(--dag-status-completed-bg);
  border-color: var(--dag-status-completed-border);
  color: var(--dag-status-completed-text);
}

.dependency-pill-running {
  background-color: var(--dag-status-running-bg);
  border-color: var(--dag-status-running-border);
  color: var(--dag-status-running-text);
}

.dependency-pill-waiting {
  background-color: var(--dag-status-waiting-bg);
  border-color: var(--dag-status-waiting-border);
  color: var(--dag-status-waiting-text);
}

.dependency-pill-failed {
  background-color: var(--dag-status-failed-bg);
  border-color: var(--dag-status-failed-border);
  color: var(--dag-status-failed-text);
}

.dependency-pill-blocked {
  background-color: var(--dag-status-waiting-bg);
  border-color: var(--dag-status-waiting-border);
  color: var(--dag-text-tertiary);
  opacity: 0.7;
}
